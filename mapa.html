<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Mapa para Acordeons Diatônicos</title>
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=0.6, minimum-scale=0.5, maximum-scale=2.0">
    <meta name="description" content="Um mapa de referência para acordeons diatônicos">
    <meta name="author" content="Flávio Luiz Vani">

    <!-- Estilos para a página e popups -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/gaitas.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/gif" href="img/favicon.gif">
  </head>
  <body>
      
    <!--
    
    TODO:
        Gerar informação no parse e inferencia da tablatura sobre a duracao total de uma nota ou manter tie info
        Usar a informação das barras de repeticao da primeira linha em todas as vozes (no gerador de midi)
        Implementar uma forma de diminuir a velocidade de uma canção (modo didático)
        done: Eliminar o uso do Kinetic
        done:Acertar a transposição (preferir o acidente junto da nota, ignorando o da pauta; 
        done:manter o acidente por todo o compasso)
        done:Melhorar a forma de pintar a tela durante geração do midi
        done:Tratar adequadamente os subtitulos - sempre fazer parte da primeira voz?

      
    
    -->  
   
    <div class="navbar navbar-inverse navbar-fixed-top" >
      <div style="background-color:#5ba4a4;">
        <div class="container" id="divTitulo" style="margin-left: 10px; width: 100%;" >
           <header>
              <div  style="float: left; width: auto;">
              <table><tr>
                <td id="DR_title"><h1>Mapa para <span>Acordeons Diatônicos</span></h1></td>
                <td style="width:5%;"></td>
                <td><a class="brand" href="#openModal" id="DR_about" >Sobre</a></td>
              </tr></table>
              </div>
              <div  style="float: right; margin-right: 20px; margin-top: 0px;">
                  <div class="btn-group">
                    <!--img src="img/brasil_80x80.png"-->
                    
                    <!--select id="selIdioma" > </select-->
                    <button class="btn label dropdown-toggle" data-toggle="dropdown" id="btn_idioma" style="padding: 2px; background-color: white">xxx</button>
                    <ul class="dropdown-menu" id="opcoes_idioma" style="padding: 1px; min-width: 32px; background-color: white">
                    </ul>
                  </div>
              </div>
	   </header>
        </div>
      </div>
    </div> <!-- /navbar -->
   
    <div class="container" id="divContainer"  style="margin-top: 0; margin-left: 10px;" >
      <div id="divMenu" class="span12" style="height:40px; margin-left: 1px;">
        <table><tr><td>
            <table class="table table-bordered table-final">
              <tr >
                <td >
                  <div class="btn-group">
                      <button class="btn label dropdown-toggle" data-toggle="dropdown"><span id="DR_acordeons">Acordeons</span> &nbsp;&nbsp;&nbsp;<span class="caret"></span></button>
                    <ul class="dropdown-menu" id="opcoes_gaita"></ul>
                  </div>
                </td >
                <td >
                    <button id="change_labels" class="btn label"><i class="icon-globe icon-white"></i>&nbsp;<span id="DR_chlabel">Mudar notação</span></button>
                </td >
                <td >
                    <a class="brand" href="#teoria"><button id="x" class="btn label" disabled>&nbsp;<span id="DR_teoria">Teoria</span></button></a>
                </td >
                <!--td >
                  <div class="btn-group">
                    <button class="btn label dropdown-toggle" data-toggle="dropdown">Afinações&nbsp;&nbsp;&nbsp;<span class="caret"></span></button>
                    <ul class="dropdown-menu" id="opcoes_afinacao"></ul>
                  </div>
                </td >
                <td >
                  <button id="sub_half_tone" class="btn label" title="reduzir meio tom"><i class="icon-circle-arrow-down icon-white"></i>&nbsp;&frac12;&nbsp;tom</button>
                  <button id="add_half_tone" class="btn label" title="aumentar meio tom"><i class="icon-circle-arrow-up icon-white"></i>&nbsp;&frac12;&nbsp;tom</button>
                </td-->
              </tr>
            </table>
           </td><td style="padding: 1%"></td><td>
            </td></tr>
          </table>
        </div>

      <div id="div_principal" class="span12" style="margin-top:5px; margin-left:1px;" >
        <ul id="faketab">
            <li><a href="#" id="a_nome_gaita">Gaita</a></li>
            <li style="margin-left: 10px">
                <div id="divMapControls">
                    <table class="table-bordered table-final" style="height: 22px"> 
                    <tr > 
                      <!--td  >
                          <b>MIDI:</b>&nbsp;
                          <input type="checkbox" id="checkboxAcordeon" checked >&nbsp;Acordeon&nbsp;&nbsp;&nbsp;&nbsp;
                          <input type="checkbox" id="checkboxPiano">&nbsp;Piano
                      </td-->
                      <td >
                          &nbsp;<b id="DR_layout">Layout:</b>&nbsp;&nbsp;
                          <input type="checkbox" id="checkboxHorizontal" checked >&nbsp;<span id="DR_horizontal">Horizontal</span>
                          &nbsp;&nbsp;
                          <input type="checkbox" id="checkboxEspelho">&nbsp;<span id="DR_espelho">Espelho</span>&nbsp;
                      </td >
                    </tr>
                  </table>
                </div>  
            </li>
        </ul>
        <div id="divContent"> 
          <div id="contentKeyboard" style="width: auto; float: left;" ></div>
          <div id="contentInfo" style=" float: right; margin-top: 15px; margin-right: 15px;">
              <table class="table table-bordered table-final" style="min-width: 220px;">
              <tr>
                <td colspan="2" style="height:200px;" id="td_imagem_gaita" >
                    <b>Loading...</b>
                </td>
              </tr>
              <!--tr>
                <td style="vertical-align: middle;">&nbsp;Acorde Atual</td>
                <td>
                  &nbsp;<span class="label" id="acordeAtualVazio">--
                  </span>
                  <span class="label label-success" id="acordeAtualFoleAbrindo" style="display: none; background-color: #00ff00" >--&nbsp;
                     <i id="abre_fole" class="icon-resize-full icon-white"></i>
                  </span>
                  <span class="label label-warning" id="acordeAtualFoleFechando" style="display: none; background-color: #00b2ee" >--&nbsp;
                      <i id="fecha_fole" class="icon-resize-small icon-white"></i>
                  </span>
                </td>
              </tr-->
            </table>
          </div>
        </div>
      </div>
      
      <div id="div_detalhes" style="float:left; margin-top:10px; margin-left:0px; width:105%;"> 
        <ul id="tabs">
            <li><a href="#" id="tabSongs">Músicas</a></li>        
            <li><a href="#" id="tabAcordes">Acordes</a></li>
            <li><a href="#" id="tabExercicios">Exercícios</a></li>
            <li style="margin-left: 10px">
                <div id="divPlayerControls">
                  <select id="selSongs" > </select>
                  <input type="button" id="playBtn" value="Executar" />
                  <input type="button" id="stopBtn" value="Parar" />
                  <input type="button" id="editorBtn" value="Editar" />
                  <input type="button" id="didaticoBtn" value="Passo a passo" disabled />
                </div>  
            </li>
        </ul>
        <div id= "content_detalhes" style="float:left; margin-top:0px; margin-left:0px; margin-bottom: 6px; width:105%; height: 340px; overflow-y: scroll;" > 
            <div id="tabSongsDiv">
               <div id="songDiv" style="display: inline;"> </div>
            </div>    
            <div id="tabAcordesDiv" >
              Em construção...
              <!--table id="chords_table" class="table table-striped">
              </table-->
            </div>
            <div id="tabExerciciosDiv" >
              Em construção...
              <!--table id="baixos_table" class="table table-striped">
              </table-->
            </div>
        </div>
      </div>

    </div> <!-- /container -->

    <div id="divEditor" style="float:left; display:none; padding-left: 0px; height: 95%; width:100%">
        <div id="editControlDiv" style="margin-top:0px; margin-left:20px;">  
            <div id="divEditArea" class="span12" style="margin-top:12px; margin-left:0px;width: 96%;">
                <textarea id="textareaABC" rows="10" style="width: 100%; color: #000; font-family: monospace"></textarea>
                <select id="selGaitas" > </select>
                <select id="selKey" ></select>
                <input type="submit" id="octaveUpBtn" value="+ Oitava" onclick="javascript:doTranspose(12);" />
                <input type="submit" id="octaveDwBtn" value="- Oitava" onclick="javascript:doTranspose(-12);" />
                <input type="button" id="printBtn" value="Ver impressão" />
                <input type="button" id="saveBtn" value="Salvar Local" disabled />
                <input type="button" id="closeBtn" value="Fechar" />
                <input type="submit" id="forceRefresh" value="Atualizar" onclick="javascript:doForceRefresh();" />
                <input type="checkbox" id="chkAutoRefresh" /><span id="DR_refresh">Auto atualização</span> 
                <input type="checkbox" id="chkDebug" onclick="javascript:doCheckDebug();" /><span id="DR_debug">Depurar</span>
            </div>
            <div id="warnings" class="span12" style="margin-top:6px; margin-left:0px;"></div>
            <div id="midi" class="span12" style="margin-top:6px; margin-left:0px;"></div>
        </div>
        <div id="canvasDivOuter" class="span12" style="margin-top:6px; margin-bottom: 6px; margin-left:20px; width:96%" >
        <div id="canvasDiv"></div>
        </div>
        
    </div> <!-- /divEditor -->  

    <div id="teoria" class="modalWindow">
      <div>
        <div class="modalHeader">
          <h2>Teoria</h2>
          <a href="#close" title="Fechar" class="close">X</a>
        </div>
        <div class="modalContent">
          <h4>Sobre tablaturas para acordeons</h4>
          <p><a href="img/p1.html">Introdução</a>
          <h4>Sobre formato ABC</h4>
          <p>adfadf
          <h4>Sobre editor de partituras</h4>
          <p>afafddf
        </div>
      </div>
    </div>
    
    <div id="openModal" class="modalWindow"> 
      <div>
        
        <div class="modalHeader">
          <h2>Sobre...</h2>
          <a href="#close" title="Fechar" class="close">X</a>
        </div>
        
        <div class="modalContent">
        <div id="clustrmaps-widget" style="float:right;   margin-left:1em;"></div><script type="text/javascript">
	   var _clustrmaps = {'url' : 'http://flvani.github.io', 'user' : 1132824, 
	   'server' : '2', 'id' : 'clustrmaps-widget', 'version' : 1, 'date' : '2014-02-19', 'lang' : 'pt', 
	   'corners' : 'square' };(function (){ var s = document.createElement('script'); 
	   s.type = 'text/javascript'; s.async = true; s.src = 'http://www2.clustrmaps.com/counter/map.js';
	    var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);})();</script>
	    <noscript><a href="http://www2.clustrmaps.com/user/617114918" target="_blank">
			<img src="http://www2.clustrmaps.com/stats/maps-no_clusters/flvani.github.io-thumb.jpg" alt="Localização dos visitantes desta página." />
			</a></noscript>
          <h3>Diatonic-Map <i>v0.93</i><br><span>Desenvolvido por <a href="mailto:flavio.vani@gmail.com"><strong>Flávio&nbsp;Vani</strong></a></span> </h3>
          <p>Este projeto pretende ser um mapa de referência para acordeons diatônicos. 
             Com ele é possível configurar -- e mostrar -- o layout de qualquer gaita de botões, nos seus mais diversos modelos.
             Quero deixar aqui, meus especiais agradecimentos ao <a href="http://www.youtube.com/watch?v=6_moobqpyyY"><strong>Prof. Cezar Ferreira</strong></a>, 
             que forneceu o material necessário para criação dos layouts e as essenciais informações sobre tablaturas para acordeons, 
             bem como, músicas e exercícios para praticar diretamente na gaita.   
          <p>Para transformar o projeto em uma ferramenta de aprendizagem, juntamos uma biblioteca  
             que permite editar partituras no formato ABC (<b>abjcs</b>) diretamente no browser. 
             O editor foi estendido para incluir uma ferramenta de transposição de tonalidades 
             e, principalmente, ampliamos a notação ABC (<i>non-standard</i>) para incluir 
             uma sintaxe para produção de tablaturas para acordeons,
             juntando o modelo ABC com os mapas de acordeons aqui apresentados.
          <p>Por fim, através da implementação das bibliotecas de MIDI para browsers (<b>MIDI.js</b>), 
             tornou-se possível ouvir os sons produzidos pelo acordeon, na forma de canções e exercícios.
             Este recurso funciona inclusive em dispositivos móveis, tais como celulares Android.  
          <p>O objetivo final é proporcionar uma experiência visual e interativa para aqueles que estão iniciando 
              seus estudos na "Gaita Ponto".
          
          <p>
          <h5>Ainda, meus sinceros agradecimentos aos autores destas bibliotecas:</h5>
          <ul>
            <li><b><a href="https://github.com/leandron/accordion-map" target="_blank">accordion-map</a> by Leandro Nunes: "An interactive reference map for diatonic accordion chords".</b> This is where all started.
            </li>
            <li><b><a href="https://github.com/paulrosen/abcjs" target="_blank">abcjs</a> by Paul Rosen: "Javascript for rendering ABC music notation".</b> A really, really great idea and a powerfull project.
            </li>
            <li><b><a href="https://github.com/mudcube/MIDI.js" target="_blank">MIDI.js</a> by Michael Deal: "Making life easy to create a MIDI-app on the web. Includes a library that convert soundfonts for Accordion into code that can be read by the browser".</b> Another great project, made of good people contributing to it.
            </li>
          </ul>
        </div>
       
        <div class="modalFooter">
          Esta obra é distribuída sob uma Licença <b rel="license" href="http://creativecommons.org/licenses/by/3.0/br/deed.pt_BR">
			   Creative Commons Atribuição 3.0 Brasil</b>.
          <a href="#cancel" title="Fechar a janela" class="cancel">Fechar</a>
          <a href="http://creativecommons.org/licenses/by/3.0/br/deed.pt_BR" target="_blank" title="Ver a licença" class="ok">Ver</a>
          <div class="clear"></div>
        </div>

      </div>
    </div> <!-- /about -->
    
    <script type="text/javascript" src="jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="proto_noconflict.js" ></script>
    
    <!-- suporte a arquivos ABC -->
    <script type="text/javascript" src="abcjs/abcjs_tabeditor_2.03-min.js" ></script>

    <!-- suporte a MIDI -->
    <script type="text/javascript" src="MIDI.js/MIDI_2.01-min.js"></script>
    
    <!-- modelos de gaitas disponíveis -->
    <!-- diatonic accordion map -->
    <script type="text/javascript" src="diatonic/diatonic-map.js"></script>
    <script type="text/javascript" src="diatonic/accordion.hohner.gc.js"></script>
    <script type="text/javascript" src="diatonic/accordion.hohner.clubIIIM.br.js"></script>
    <script type="text/javascript" src="diatonic/accordion.hohner.clubIIIM.js"></script>
    <script type="text/javascript" src="diatonic/accordion.hohner.coronaII.js"></script>

    <!-- suporte aos mapas de teclados -->
    <script type="text/javascript" src="js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="js/funcoes.js"></script>

    <script type="text/javascript" src="map/map.js"></script>
    <script type="text/javascript" src="map/gaita.js"></script>
    <script type="text/javascript" src="map/button.js"></script>
    
    <script type="text/javascript" src="player/player.js"></script>
    <script type="text/javascript" src="Loader.js"></script>
    
    <script type="text/javascript" src="js/resource.js"></script>
    
    <script type="text/javascript">
        
        var myMap;
        
        DR_carregaIdiomas();
        
        DR_register( "DR_title" );        
        DR_register( "DR_about" );        
        DR_register( "tabSongs" );        
        DR_register( "tabAcordes" );        
        DR_register( "tabExercicios" );        
        
        DR_register( "editorBtn" );        
        DR_register( "playBtn" );        
        DR_register( "didaticoBtn" );        
        DR_register( "stopBtn" );        

        DR_register("DR_layout")
        DR_register("DR_espelho");
        DR_register("DR_horizontal");
        DR_register("DR_acordeons");
        DR_register("DR_chlabel");
        DR_register("DR_teoria");

        DR_register("octaveUpBtn");
        DR_register("octaveDwBtn");
        DR_register("printBtn");
        DR_register("saveBtn");
        DR_register("closeBtn");
        DR_register("forceRefresh");
        DR_register("DR_refresh");
        DR_register("DR_debug");

    
        window.addEventListener('load', initApp, false);
        window.editorButton = document.getElementById("editorBtn");
        window.playButton = document.getElementById("playBtn");
        window.didaticoButton = document.getElementById("didaticoBtn");
        window.stopButton = document.getElementById("stopBtn");
        window.printButton = document.getElementById("printBtn");
        window.closeButton = document.getElementById("closeBtn");

        function initApp() {
            
            var myEditor = new ABCJS.Editor(
                         "textareaABC"
                      ,{
                         canvas_id: "canvasDiv"
                        //,midi_id: "midi"
                        ,warnings_id: "warnings"
                        ,refreshController_id: "chkAutoRefresh"
                        ,accordionSelector_id: "selGaitas"
                        ,keySelector_id: "selKey"
                        ,midi_options: {program: 21, qpm: 150, type: "qt"}
                        ,render_options: {}
                        ,gui: false
                      });
                    
            myMap = new DIATONIC.map.Map(
                    myEditor
                    ,
                    { 
                       ckPiano: 'checkboxPiano'
                      ,ckAccordion: 'checkboxAcordeon'
                      ,ckMirror: 'checkboxEspelho'
                      ,ckHorizontal: 'checkboxHorizontal'
                      ,accordionNamePlaceHolder: 'a_nome_gaita'
                      ,accordionImagePlaceHolder: 'td_imagem_gaita'
                      ,accordionParams: { 
                         songDiv: 'songDiv' 
                        ,songContainerDiv: 'tabSongsDiv'
                        ,keyboardContentDiv: 'contentKeyboard'
                        ,tabContentDiv: 'content_detalhes'
                        ,songSelector: 'selSongs' 
                      }
                    } 
                 );

            // populas listas drop-down        
            myMap.carregaListaGaitas();
            myMap.carregaListaAfinacoesComuns();

            // configura e mostra a gaita inicial
            myMap.gaita.setup( {
                   accordionId: 'GAITA_HOHNER_GC' 
                  //,songTitle:"J'ai vu le loup, le renard et la belette"
                  //,songTitle:"Valsa Sertaneja"
                  ,songTitle:"Hino do Grêmio"
                   } );
        }
        
        $(document).ready(function() {
            
          $("#content_detalhes").find("[id^='tab']").hide(); // Hide all content
          //$("#contentKeyboard").hide(); 
          
            MIDI.loader = new widgets.Loader();
            MIDI.loadPlugin({
                soundfontUrl: "./soundfont/"
               //,instruments: "acoustic_grand_piano"
               ,instruments: "accordion"
               //,instruments: ["accordion", "acoustic_grand_piano"]
               //,targetFormat: "mp3"
               ,callback: function() {
                  MIDI.loader.stop();
                  //MIDI.programChange(0, 0); // piano
                  MIDI.programChange(0, 21); // canais para accordeon
                  MIDI.programChange(1, 21); // canais para accordeon
                  $("#tabs li:first").attr("id","current"); // Activate the first tab
                  $("#content_detalhes #tabSongs" ).fadeIn(); // Show first tab's content
                  $("#contentKeyboard" ).fadeIn(); 
                }
            });
            

//                  $("#tabs li:first").attr("id","current"); // Activate the first tab
//                  $("#content_detalhes #tabAcordes" ).fadeIn(); // Show first tab's content
//                  $("#contentKeyboard" ).fadeIn(); 

          $('#tabs a').click(function(e) {
              e.preventDefault();
              if ($(this).closest("li").attr("id") === "current"){ //detection for current tab
                return;       
              } else{             
                $("#content_detalhes").find("[id^='tab']").hide(); // Hide all content
                $("#tabs li").attr("id",""); //Reset id's
                $(this).parent().attr("id","current"); // Activate this
                $('#' + $(this).attr('id')+"Div").fadeIn(); // Show content for the current tab
                if( $(this).attr('id') === "tabSongs" )
                    $("#divPlayerControls" ).fadeIn();
                else
                    $("#divPlayerControls" ).hide();
              }
          });
        });
        
        $('#contentKeyboard').on('mouseover', function () {
          //if(myMap.gaita.player)
            //myMap.gaita.player.stopPlayingNClear();
        });
        
         $('#change_labels').on('click', function () {
          myMap.gShowLabel = !myMap.gShowLabel;
          myMap.gaita.redrawKeyboard();
        });

        $('#sub_half_tone').on('click', function () {
          if ( myMap.toneOffSet + myMap.gaita.minNoteInUse > myMap.gaita.minNote ) {
            --myMap.toneOffSet;
            myMap.gaita.redrawKeyboard();
          } else {
            alert( "Limite mínimo atingido!" );
          }
        });

        $('#add_half_tone').on('click', function () {
          if ( myMap.toneOffSet + myMap.gaita.maxNoteInUse < myMap.gaita.maxNote ) {
            ++myMap.toneOffSet;
            myMap.gaita.redrawKeyboard();
          } else {
            alert( "Limite máximo atingido!" );
          }
        });

        function set_pop_tone(value) {
            myMap.set_pop_tone(value);
        };

        function setupGaita(value) {
            myMap.gaita.setup({accordionId:value});
        };

        printButton.addEventListener("click", function() {
            $("#divTitulo").hide();
            $("#editControlDiv").hide();
            window.print();
            $("#divTitulo").fadeIn();
            $("#editControlDiv").fadeIn();
        }, false);

        playButton.addEventListener("click", function() {
            if( ! myMap.gaita.renderedTune ) return;
            myMap.gaita.playRenderedSong(playButton);
        }, false);
        
        didaticoButton.addEventListener("click", function() {
            if( ! myMap.gaita.renderedTune ) return;
            myMap.gaita.didaticPlayRenderedSong(didaticoButton);
        }, false);
        
        stopButton.addEventListener("click", function() {
            if( ! myMap.gaita.renderedTune ) return;
            myMap.gaita.stopRenderedSong(playButton);
        }, false);
                
        editorButton.addEventListener("click", function() {
            if( ! myMap.gaita.renderedTune ) return;
            $("#divContainer").hide();
            $("#divEditor").fadeIn();
            myMap.editor.div.innerHTML = myMap.gaita.songDiv.innerHTML;
        }, false);
        
        closeButton.addEventListener("click", function() {
            $("#divEditor").hide();
            $("#divContainer").fadeIn();
            myMap.gaita.printTune();
  
        }, false);

        function doTranspose(value) {
            myMap.editor.fireChanged(value, "force");
        };

        function doForceRefresh() {
            myMap.editor.fireChanged(0, "force");
        };

        function doCheckDebug() {
            debug = document.getElementById("chkDebug").checked;
            myMap.Editor.fireChanged(0, "force");
        };

  </script>
        
  </body>
</html>
